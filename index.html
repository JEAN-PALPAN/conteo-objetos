<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de Objetos con Base de Datos</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; display: flex; flex-direction: column; align-items: center;
            padding: 20px; color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); width: 100%; max-width: 1200px;
            backdrop-filter: blur(10px);
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 {
            font-size: 2.5em; margin-bottom: 10px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .tab {
            padding: 12px 25px; border: none; border-radius: 10px; background: #3498db; color: white;
            cursor: pointer; font-weight: 600; transition: all 0.3s ease;
        }
        .tab.active { background: #27ae60; }
        .tab:hover { transform: translateY(-2px); }

        .video-container {
            position: relative; width: 100%; max-width: 800px; margin: 0 auto 20px;
            border-radius: 15px; overflow: hidden; background: #000;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }
        video { width: 100%; border-radius: 15px; display: block; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #3498db, #2980b9); padding: 20px; border-radius: 15px; text-align: center; color: white; box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3); }
        .stat-card.success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .stat-card.warning { background: linear-gradient(135deg, #e67e22, #d35400); }
        .stat-card h3 { font-size: 0.9em; margin-bottom: 10px; opacity: 0.9; }
        .stat-card .number { font-size: 2.5em; font-weight: bold; }

        .controls { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
        .btn { padding: 15px 25px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; color: white; }
        .btn-primary { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .btn-secondary { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .status { text-align: center; padding: 15px; border-radius: 10px; margin: 20px 0; font-weight: 500; }
        .status-loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .objects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .object-card { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid #3498db; }
        .object-name { font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .object-count { font-size: 1.5em; color: #27ae60; font-weight: bold; }
        .object-confidence { color: #666; font-size: 0.9em; }

        .database-section { background: #f8f9fa; border-radius: 15px; padding: 20px; margin-top: 20px; }
        .database-section h3 { color: #2c3e50; margin-bottom: 15px; text-align: center; }
        .history-list { max-height: 400px; overflow-y: auto; }
        .history-item {
            background: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; display: flex;
            justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }

        .progress-container { width: 100%; background: #e0e0e0; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 20px; background: linear-gradient(90deg, #3498db, #2980b9); border-radius: 10px; transition: width 0.3s ease; text-align: center; color: white; font-weight: bold; line-height: 20px; }

        .api-status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .api-status.connected { background: #27ae60; box-shadow: 0 0 10px #27ae60; }
        .api-status.disconnected { background: #e74c3c; box-shadow: 0 0 10px #e74c3c; }

        @media (max-width: 768px) {
            .container { padding: 20px; }
            .stats-container { grid-template-columns: 1fr; }
            .objects-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Detector de Objetos Inteligente</h1>
            <p>Detecci√≥n en tiempo real + Base de Datos Neon.tech</p>
            <p style="font-size: 0.9em; margin-top: 10px;">
                <span id="apiStatusIndicator" class="api-status disconnected"></span>
                <span id="apiStatusText">Verificando conexi√≥n...</span>
            </p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('camera', this)">üìπ C√°mara en Vivo</button>
            <button class="tab" onclick="showTab('video', this)">üé¨ Analizar Video</button>
            <button class="tab" onclick="showTab('database', this)">üíæ Base de Datos</button>
        </div>

        <!-- Pesta√±a C√°mara -->
        <div id="cameraTab" class="tab-content">
            <div class="video-container">
                <video id="cameraVideo" width="800" height="600" autoplay muted playsinline></video>
                <canvas id="cameraCanvas"></canvas>
            </div>

            <div class="controls">
                <button id="btnStartCamera" class="btn btn-primary" onclick="startCamera()">üìπ Iniciar C√°mara</button>
                <button id="btnStopCamera" class="btn btn-danger" onclick="stopCamera()" disabled>‚èπÔ∏è Detener</button>
                <button id="btnSaveDetection" class="btn btn-secondary" onclick="saveCurrentDetection()">üíæ Guardar en BD</button>
            </div>
        </div>

        <!-- Pesta√±a Video -->
        <div id="videoTab" class="tab-content hidden">
            <div class="video-container">
                <video id="fileVideo" controls></video>
                <canvas id="fileCanvas"></canvas>
            </div>

            <div class="controls">
                <input type="file" id="videoFile" accept="video/*" style="display: none;">
                <label for="videoFile" class="btn btn-secondary">üìÅ Seleccionar Video</label>
                <button id="btnAnalyzeVideo" class="btn btn-primary" onclick="analyzeVideo()">üîç Analizar Video</button>
                <button id="btnSaveVideo" class="btn btn-secondary" onclick="saveVideoDetection()">üíæ Guardar Resultados</button>
            </div>

            <div class="progress-container">
                <div id="videoProgress" class="progress-bar" style="width: 0%">0%</div>
            </div>
        </div>

        <!-- Pesta√±a Base de Datos -->
        <div id="databaseTab" class="tab-content hidden">
            <div class="database-section">
                <h3>üìä Historial de Detecciones (Neon.tech)</h3>
                <div class="controls">
                    <button class="btn btn-primary" onclick="loadDetectionHistory()">üîÑ Cargar Historial</button>
                    <button class="btn btn-secondary" onclick="loadStats()">üìà Ver Estad√≠sticas</button>
                    <button class="btn btn-danger" onclick="clearDatabase()">üóëÔ∏è Limpiar BD</button>
                </div>
                <div id="statsSection" class="hidden" style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Estad√≠sticas Generales</h4>
                    <div id="statsContent"></div>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>
        </div>

        <div id="status" class="status status-loading">
            <span class="loading"></span> Cargando modelo de IA...
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <h3>Total de Objetos</h3>
                <div class="number" id="totalObjects">0</div>
            </div>
            <div class="stat-card success">
                <h3>Tipos Detectados</h3>
                <div class="number" id="uniqueObjects">0</div>
            </div>
            <div class="stat-card warning">
                <h3>Confianza Promedio</h3>
                <div class="number" id="avgConfidence">0%</div>
            </div>
        </div>

        <div id="objectsContainer" class="objects-grid"></div>
    </div>

    <script>
        // ============================================================
        // Helpers de color y forma
        // ============================================================
        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

        function rgbToHsv(r, g, b) {
            r/=255; g/=255; b/=255;
            const max = Math.max(r,g,b), min = Math.min(r,g,b);
            const d = max - min;
            let h = 0;
            if (d !== 0) {
                switch (max) {
                    case r: h = ((g - b) / d) % 6; break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h *= 60; if (h < 0) h += 360;
            }
            const s = max === 0 ? 0 : d / max;
            const v = max;
            return { h, s, v };
        }

        function colorNameFromHSV({h, s, v}) {
            if (v < 0.15) return 'negro';
            if (s < 0.15) return v > 0.85 ? 'blanco' : 'gris';
            if (h < 15 || h >= 345) return 'rojo';
            if (h < 35) return 'naranja';
            if (h < 60) return 'amarillo';
            if (h < 90) return 'lima';
            if (h < 150) return 'verde';
            if (h < 200) return 'cian';
            if (h < 255) return 'azul';
            if (h < 290) return '√≠ndigo';
            if (h < 330) return 'morado';
            return 'rosado';
        }

        const analysisCanvas = document.createElement('canvas');
        const analysisCtx = analysisCanvas.getContext('2d', { willReadFrequently: true });

        function dominantColorFromRegion(sourceEl, x, y, w, h, step = 10) {
            try {
                const sw = sourceEl.videoWidth || sourceEl.width;
                const sh = sourceEl.videoHeight || sourceEl.height;
                if (!sw || !sh) return {r:127,g:127,b:127};

                analysisCanvas.width = sw; analysisCanvas.height = sh;
                analysisCtx.drawImage(sourceEl, 0, 0, sw, sh);

                const cx = x + w*0.2, cy = y + h*0.2, cw = w*0.6, ch = h*0.6;
                const rx = clamp(Math.floor(cx), 0, sw-1);
                const ry = clamp(Math.floor(cy), 0, sh-1);
                const rw = clamp(Math.floor(cw), 1, sw - rx);
                const rh = clamp(Math.floor(ch), 1, sh - ry);

                const img = analysisCtx.getImageData(rx, ry, rw, rh).data;
                let r=0,g=0,b=0,count=0;
                for (let j=0; j<rh; j+=step) {
                    for (let i=0; i<rw; i+=step) {
                        const idx = ((j*rw)+i)*4;
                        r += img[idx]; g += img[idx+1]; b += img[idx+2];
                        count++;
                    }
                }
                if (count === 0) return {r:127,g:127,b:127};
                return { r: Math.round(r/count), g: Math.round(g/count), b: Math.round(b/count) };
            } catch {
                return {r:127,g:127,b:127};
            }
        }

        function basicShapeFromBBox(w, h) {
            const ratio = w / h;
            if (ratio > 1.3) return 'alargado horizontal';
            if (ratio < 0.77) return 'alargado vertical';
            return 'cuadrado/aprox.';
        }

        function enrichDetectionsWithColorShape(predictions, sourceEl) {
            return predictions.map(p => {
                const [x,y,w,h] = p.bbox;
                const rgb = dominantColorFromRegion(sourceEl, x,y,w,h, 12);
                const hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
                const colorName = colorNameFromHSV(hsv);
                const shape = basicShapeFromBBox(w,h);
                return { ...p, _colorName: colorName, _shape: shape };
            });
        }

        // ============================================================
        // App
        // ============================================================
        // API URL (local vs Netlify Function)
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api'
            : '/.netlify/functions/api';

        // Elementos DOM
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const fileVideo = document.getElementById('fileVideo');
        const fileCanvas = document.getElementById('fileCanvas');
        const statusDiv = document.getElementById('status');
        const totalObjectsEl = document.getElementById('totalObjects');
        const uniqueObjectsEl = document.getElementById('uniqueObjects');
        const avgConfidenceEl = document.getElementById('avgConfidence');
        const objectsContainer = document.getElementById('objectsContainer');
        const historyList = document.getElementById('historyList');
        const videoProgress = document.getElementById('videoProgress');
        const apiStatusIndicator = document.getElementById('apiStatusIndicator');
        const apiStatusText = document.getElementById('apiStatusText');
        const statsSection = document.getElementById('statsSection');
        const statsContent = document.getElementById('statsContent');

        // Estado
        let model = null;
        let cameraStream = null;
        let detectionInterval = null;
        let currentDetections = [];
        let isApiConnected = false;

        // Clases COCO
        const COCO_CLASSES = [
            'person','bicycle','car','motorcycle','airplane','bus','train','truck','boat','traffic light',
            'fire hydrant','stop sign','parking meter','bench','bird','cat','dog','horse','sheep','cow',
            'elephant','bear','zebra','giraffe','backpack','umbrella','handbag','tie','suitcase','frisbee',
            'skis','snowboard','sports ball','kite','baseball bat','baseball glove','skateboard','surfboard',
            'tennis racket','bottle','wine glass','cup','fork','knife','spoon','bowl','banana','apple',
            'sandwich','orange','broccoli','carrot','hot dog','pizza','donut','cake','chair','couch',
            'potted plant','bed','dining table','toilet','tv','laptop','mouse','remote','keyboard',
            'cell phone','microwave','oven','toaster','sink','refrigerator','book','clock','vase',
            'scissors','teddy bear','hair drier','toothbrush'
        ];

        // Conexi√≥n API
        async function checkAPIConnection() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'ok') {
                        isApiConnected = true;
                        apiStatusIndicator.className = 'api-status connected';
                        apiStatusText.textContent = 'Conectado a Neon.tech';
                        return true;
                    }
                }
                throw new Error('API no disponible');
            } catch {
                isApiConnected = false;
                apiStatusIndicator.className = 'api-status disconnected';
                apiStatusText.textContent = 'API desconectada (modo local)';
                return false;
            }
        }

        // Modelo
        async function loadModel() {
            try {
                statusDiv.innerHTML = '<span class="loading"></span> Cargando modelo de IA...';
                statusDiv.className = 'status status-loading';
                model = await cocoSsd.load();
                statusDiv.textContent = '‚úÖ Modelo cargado - Listo para detectar objetos';
                statusDiv.className = 'status status-success';
            } catch (error) {
                statusDiv.textContent = '‚ùå Error cargando modelo: ' + error.message;
                statusDiv.className = 'status status-error';
            }
        }

        // Tabs
        function showTab(tabName, btnEl) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById(tabName + 'Tab').classList.remove('hidden');

            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');
        }

        // C√°mara
        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { width: 800, height: 600 } });
                cameraVideo.srcObject = cameraStream;

                cameraVideo.onloadedmetadata = () => {
                    cameraCanvas.width = cameraVideo.videoWidth;
                    cameraCanvas.height = cameraVideo.videoHeight;
                    startCameraDetection();
                };

                document.getElementById('btnStartCamera').disabled = true;
                document.getElementById('btnStopCamera').disabled = false;
                statusDiv.textContent = '‚úÖ C√°mara iniciada - Detectando objetos...';
                statusDiv.className = 'status status-success';
            } catch (error) {
                statusDiv.textContent = '‚ùå Error accediendo a la c√°mara: ' + error.message;
                statusDiv.className = 'status status-error';
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            if (detectionInterval) clearInterval(detectionInterval);
            document.getElementById('btnStartCamera').disabled = false;
            document.getElementById('btnStopCamera').disabled = true;
            statusDiv.textContent = '‚úÖ C√°mara detenida';
            statusDiv.className = 'status status-success';
        }

        function startCameraDetection() {
            detectionInterval = setInterval(async () => {
                if (cameraVideo.paused || cameraVideo.ended) return;
                const predictions = await model.detect(cameraVideo);
                const enriched = enrichDetectionsWithColorShape(predictions, cameraVideo);
                currentDetections = enriched;
                updateObjectsDisplay(enriched);
                drawDetections(cameraCanvas, enriched);
            }, 500);
        }

        // Video
        document.getElementById('videoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                fileVideo.src = url;
                fileVideo.onloadedmetadata = () => {
                    fileCanvas.width = fileVideo.videoWidth;
                    fileCanvas.height = fileVideo.videoHeight;
                };
            }
        });

        async function analyzeVideo() {
            if (!fileVideo.src) { alert('Por favor selecciona un video primero.'); return; }

            fileVideo.currentTime = 0;
            await fileVideo.play();

            const duration = fileVideo.duration || 0;
            let analyzedFrames = 0;
            const totalFrames = Math.max(1, Math.floor(duration * 2)); // 2 FPS

            fileVideo.ontimeupdate = async () => {
                if (analyzedFrames >= totalFrames) {
                    fileVideo.pause();
                    statusDiv.textContent = '‚úÖ An√°lisis de video completado';
                    statusDiv.className = 'status status-success';
                    return;
                }
                if (fileVideo.currentTime >= (analyzedFrames / 2)) {
                    const predictions = await model.detect(fileVideo);
                    const enriched = enrichDetectionsWithColorShape(predictions, fileVideo);
                    currentDetections = enriched;
                    updateObjectsDisplay(enriched);
                    drawDetections(fileCanvas, enriched);

                    analyzedFrames++;
                    const progress = (analyzedFrames / totalFrames) * 100;
                    videoProgress.style.width = progress + '%';
                    videoProgress.textContent = Math.round(progress) + '%';
                }
            };
        }

        // UI de objetos
        function updateObjectsDisplay(predictions) {
            const objectCounts = {};
            let totalConfidence = 0;
            let totalObjects = 0;

            predictions.forEach(pred => {
                const className = pred.class;
                const confidence = pred.score;
                const color = pred._colorName || '‚Äî';
                const shape = pred._shape || '‚Äî';

                if (!objectCounts[className]) {
                    objectCounts[className] = {
                        count: 0, totalConfidence: 0, colors: {}, shapes: {}
                    };
                }
                objectCounts[className].count++;
                objectCounts[className].totalConfidence += confidence;
                objectCounts[className].colors[color] = (objectCounts[className].colors[color] || 0) + 1;
                objectCounts[className].shapes[shape] = (objectCounts[className].shapes[shape] || 0) + 1;

                totalConfidence += confidence;
                totalObjects++;
            });

            totalObjectsEl.textContent = totalObjects;
            uniqueObjectsEl.textContent = Object.keys(objectCounts).length;
            avgConfidenceEl.textContent = totalObjects > 0 ? Math.round((totalConfidence / totalObjects) * 100) + '%' : '0%';

            objectsContainer.innerHTML = '';
            Object.entries(objectCounts).forEach(([className, data]) => {
                const avgConf = (data.totalConfidence / data.count) * 100;
                const topColor = Object.entries(data.colors).sort((a,b)=>b[1]-a[1])[0]?.[0] || '‚Äî';
                const topShape = Object.entries(data.shapes).sort((a,b)=>b[1]-a[1])[0]?.[0] || '‚Äî';

                const objectCard = document.createElement('div');
                objectCard.className = 'object-card';
                objectCard.innerHTML = `
                    <div class="object-name">${className}</div>
                    <div class="object-count">${data.count}</div>
                    <div class="object-confidence">${Math.round(avgConf)}% confianza</div>
                    <div style="margin-top:6px;color:#444;font-size:.9em">
                        üé® <strong>Color:</strong> ${topColor} &nbsp; | &nbsp; ‚¨õ <strong>Forma:</strong> ${topShape}
                    </div>
                `;
                objectsContainer.appendChild(objectCard);
            });
        }

        function drawDetections(canvas, predictions) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            predictions.forEach(pred => {
                const [x, y, width, height] = pred.bbox;
                const confidence = Math.round(pred.score * 100);

                const hue = COCO_CLASSES.indexOf(pred.class) * 137.508 % 360;
                const color = `hsl(${hue}, 70%, 50%)`;

                // Caja
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, width, height);

                // Texto
                ctx.font = '16px Arial';
                const text = `${pred.class} ${confidence}% ‚Äî ${pred._colorName || ''} ‚Ä¢ ${pred._shape || ''}`;
                const textWidth = ctx.measureText(text).width;
                const textX = x;
                const textY = (y - 25 < 0) ? y + 20 : y - 25;

                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(textX, textY - 18, textWidth + 10, 22);
                ctx.fillStyle = 'white';
                ctx.fillText(text, textX + 5, textY);

            });

            // Contador general
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(10, 10, 280, 60);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px Arial';
            ctx.fillText(`Objetos: ${predictions.length}`, 20, 35);
            ctx.font = '16px Arial';
            ctx.fillText(`Tipos: ${new Set(predictions.map(p => p.class)).size}`, 20, 55);
        }

        // BD Neon.tech v√≠a API
        async function saveToDatabase(detectionData) {
            if (!isApiConnected) {
                statusDiv.textContent = '‚ö†Ô∏è API no disponible. Inicia el servidor backend primero.';
                statusDiv.className = 'status status-error';
                return;
            }
            try {
                statusDiv.innerHTML = '<span class="loading"></span> Guardando en Neon.tech...';
                statusDiv.className = 'status status-loading';

                const response = await fetch(`${API_URL}/detections`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: cameraStream ? 'camera' : 'video',
                        objects: detectionData
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error en la respuesta del servidor');
                }

                await response.json();
                statusDiv.textContent = '‚úÖ Datos guardados exitosamente en Neon.tech';
                statusDiv.className = 'status status-success';

                setTimeout(() => {
                    statusDiv.textContent = cameraStream ? '‚úÖ C√°mara activa - Detectando objetos...' : '‚úÖ Listo para detectar';
                    statusDiv.className = 'status status-success';
                }, 2000);
            } catch (error) {
                statusDiv.textContent = '‚ùå Error guardando: ' + error.message;
                statusDiv.className = 'status status-error';
            }
        }

        async function saveCurrentDetection() {
            if (currentDetections.length === 0) { alert('No hay detecciones para guardar. Inicia la c√°mara primero.'); return; }
            await saveToDatabase(currentDetections);
        }
        async function saveVideoDetection() {
            if (currentDetections.length === 0) { alert('Analiza el video primero para obtener detecciones.'); return; }
            await saveToDatabase(currentDetections);
        }

        async function loadDetectionHistory() {
            if (!isApiConnected) {
                historyList.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 20px;">‚ö†Ô∏è API no disponible. Inicia el servidor backend.</div>';
                return;
            }
            try {
                statusDiv.innerHTML = '<span class="loading"></span> Cargando historial desde Neon.tech...';
                statusDiv.className = 'status status-loading';

                const response = await fetch(`${API_URL}/detections?limit=50`);
                if (!response.ok) throw new Error('Error cargando historial');

                const result = await response.json();
                const history = result.data || [];
                historyList.innerHTML = '';

                if (history.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">üì≠ No hay registros en la base de datos</div>';
                    statusDiv.textContent = '‚úÖ Base de datos vac√≠a';
                    statusDiv.className = 'status status-success';
                    return;
                }

                history.forEach(record => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.style.flexDirection = 'column';
                    historyItem.style.alignItems = 'flex-start';

                    const date = new Date(record.timestamp);
                    const timeString = date.toLocaleString('es-PE', {
                        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                    });

                    historyItem.innerHTML = `
                        <div style="display:flex;justify-content:space-between;width:100%;margin-bottom:8px;">
                            <div>
                                <strong>${timeString}</strong>
                                <div style="font-size:0.8em;color:#666;">
                                    ${record.total_objects} objetos, ${record.unique_objects} tipos | üìç ${record.source}
                                </div>
                            </div>
                            <div style="font-weight:bold;color:#27ae60;">
                                ${Math.round(record.avg_confidence)}%
                            </div>
                        </div>
                        <div style="background:#f8f9fa;padding:8px 12px;border-radius:6px;width:100%;font-size:0.9em;color:#2c3e50;">
                            üè∑Ô∏è <strong>Objetos:</strong> ${record.detected_objects || 'N/A'}
                        </div>
                    `;
                    historyList.appendChild(historyItem);
                });

                statusDiv.textContent = `‚úÖ Cargados ${history.length} registros desde Neon.tech`;
                statusDiv.className = 'status status-success';
            } catch (error) {
                statusDiv.textContent = '‚ùå Error cargando historial: ' + error.message;
                statusDiv.className = 'status status-error';
                historyList.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå Error cargando datos</div>';
            }
        }

        async function loadStats() {
            if (!isApiConnected) { alert('API no disponible. Inicia el servidor backend primero.'); return; }
            try {
                statusDiv.innerHTML = '<span class="loading"></span> Cargando estad√≠sticas...';
                statusDiv.className = 'status status-loading';

                const response = await fetch(`${API_URL}/stats`);
                if (!response.ok) throw new Error('Error cargando estad√≠sticas');

                const result = await response.json();
                const stats = result.stats || {};

                statsSection.classList.remove('hidden');
                statsContent.innerHTML = `
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #3498db;">
                            <div style="color:#666;font-size:.9em;">Total Detecciones</div>
                            <div style="font-size:2em;font-weight:bold;color:#2c3e50;">${stats.total_detections || 0}</div>
                        </div>
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #27ae60;">
                            <div style="color:#666;font-size:.9em;">Total Objetos</div>
                            <div style="font-size:2em;font-weight:bold;color:#2c3e50;">${stats.total_objects_detected || 0}</div>
                        </div>
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #e67e22;">
                            <div style="color:#666;font-size:.9em;">Confianza Promedio</div>
                            <div style="font-size:2em;font-weight:bold;color:#2c3e50;">${Math.round(stats.overall_avg_confidence || 0)}%</div>
                        </div>
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #9b59b6;">
                            <div style="color:#666;font-size:.9em;">M√°ximo en Detecci√≥n</div>
                            <div style="font-size:2em;font-weight:bold;color:#2c3e50;">${stats.max_objects_in_detection || 0}</div>
                        </div>
                    </div>
                `;

                statusDiv.textContent = '‚úÖ Estad√≠sticas cargadas';
                statusDiv.className = 'status status-success';
            } catch (error) {
                statusDiv.textContent = '‚ùå Error cargando estad√≠sticas: ' + error.message;
                statusDiv.className = 'status status-error';
            }
        }

        async function clearDatabase() {
            if (!isApiConnected) { alert('API no disponible. Inicia el servidor backend primero.'); return; }
            if (!confirm('‚ö†Ô∏è ¬øEliminar TODAS las detecciones de Neon.tech? Esta acci√≥n NO se puede deshacer.')) return;

            try {
                statusDiv.innerHTML = '<span class="loading"></span> Limpiando base de datos...';
                statusDiv.className = 'status status-loading';

                const response = await fetch(`${API_URL}/detections`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Error limpiando base de datos');

                const result = await response.json();
                historyList.innerHTML = '<div style="text-align:center;color:#27ae60;padding:20px;">‚úÖ Base de datos limpiada exitosamente</div>';
                statsSection.classList.add('hidden');

                statusDiv.textContent = '‚úÖ ' + (result.message || 'BD limpiada');
                statusDiv.className = 'status status-success';
            } catch (error) {
                statusDiv.textContent = '‚ùå Error limpiando base de datos: ' + error.message;
                statusDiv.className = 'status status-error';
            }
        }

        // Init
        window.addEventListener('load', async () => {
            await loadModel();
            await checkAPIConnection();
            if (isApiConnected) {
                loadDetectionHistory();
            } else {
                historyList.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#e67e22;">
                        <p style="font-size:1.2em;margin-bottom:10px;">‚ö†Ô∏è Servidor Backend No Detectado</p>
                        <p style="font-size:.9em;color:#666;">
                            Para usar la base de datos Neon.tech:<br>
                            1. Abre la terminal en la carpeta del backend<br>
                            2. Ejecuta: <code style="background:#f0f0f0;padding:2px 8px;border-radius:4px;">npm start</code><br>
                            3. Recarga esta p√°gina
                        </p>
                    </div>
                `;
            }
        });

        // Reintento de conexi√≥n cada 30s si est√° desconectado
        setInterval(async () => {
            if (!isApiConnected) await checkAPIConnection();
        }, 30000);
    </script>
</body>
</html>